## 📆 2025-10-23

### 🔔 스크럼

- Spring에서 파일 처리 강의 복습 및 정리
- 6주차 과제 수행하기
  - 게시물 수정기능
  - 회원정보 수정 기능
  - 게시물 상세 좋아요 기능
  - QA 문서 만들고 완성한곳 까지 진행

### 🚀 Today I Learned

#### 문제 정의하기

- 목표 : 커뮤니티에 이미지 파일 사용하기
- 시나리오
  1. 이미지 파일을 업로드한다
  2. 업로드된 이미지 파일에 접근한다
- 필요한 기능
  1. 파일 업로드 기능
  2. 파일 접근 기능

#### 개략적 설계하기

- 파일 업로드, 접근을 하기 위해 어떤 고민을 해야할까?
  - **서버 환경** : 현재는 로컬기준이지만 클라우드 배포하면 어떻게할지 확장성만 고려
  - **파일형태** : jpg,png, webp 지원, 고용량 파일은 지원X, 파일 크기 제한은 10MB 이하
    - 미지원 이미지 파일 형식 처리 방식 : 일단은 deny, 이후에는 포맷변환 기능 제공할수도?
  - **압축 및 변환**
    - 파일 포맷 일관성
      - 지원하는 파일들을 모두 jpg와 webp가 동시에 있는 형태로 변환 후 저장(webp지원안하는 거때문에 jpg도 같이 저장)
      - 브라우저가 webp 형태를 지원한다면, webp제공
    - 압축 기능
      - 유형별 파일 압축 필요
      - 프로필 사진 : 압축률 60% 설정
      - 게시글 사진 : 원본 사진은 20%, 썸네일용 60%
      - %는 중요하지 X, %가 다르다는것만 인지하면됨.
  - **데이터 저장 방식**
    - 스토리지(로컬 or 클라우드)에 파일 저장
    - 파일에 대한 정보는 RDB에 저장함(스토리지 접근경로, 썸네일 접근경로, 생성일, 활성 여부 등)
  - 외에도 고민할거 있음 - 저장위치, 권한, 서버 부하 등(일단은 넘어감)

#### 구현하기

- 설계를 기준으로, 백엔드에서 구현할 플로우 및 코드 구조 설계하기
- 파일 업로드시
  - 클라이언트 파일 업로드 시도
  - was 에서 파일 저장처리
    - 파일 관련 추가 처리 진행
    - 스프링 정적 리소스 저장
    - 파일 접근 정보 알디비 저장
- 파일 접근시 : 따로 api필요없을듯?
  - 클라이언트 파일 접근 시도
  - was 정적 리소스 서빙
- 파일 업로드시 백엔드에서 필요한 작업들
  - 파일 검증
  - 포맥 확인 및 처리
  - 압출 처리
  - 파일 업로드 처리
  - 파일 정보 저장
- 코드 짜기 전에 코드 책임 설계 - 컨트롤러, 서비스 등 클래스 단일 책임 원칙!
- 코드짜기 : 외부 의존성이 적은거 부터 - ImageProessor
  - 파일 서비스 인터페이스 고려 : 향후 클라우드 확장 가능성 고려(= 스토리지 의존적X)
    - imageSErvice→ FileService → LocalFileService & CloudFileService
  - 파일 서비스 구현제 작성(LocalFileService implements FileService)
  - Request Dto 정의 : FileUPloadREquestDto, 파일 크기 관련 설정은 application.yml/properties에 할수있음
  - 이미지 엔티티 및 레포지토리 생성
  - 이미지 서비스 작성 : 서비스 코드는 너무 길면안됨. 책임 분리!
  - 이미지 컨트롤러 작성
- 추가 고민거리?
  - 스토리지 확장성 - s3FileService implemets Fileservice만 짜면됨
  - 인프라 확장성
  - 고아 이미지 처리 : 실제로는 아무도 접근하지 않는데, 스토리지에만 남아있는 이미지

### 🔥 오늘의 도전 과제와 해결 방법

- 이미지 포함된 데이터들 백으로 안넘어감 : 프론트쪽에 백엔드URL보호를 위해 프록시 서버를 만들어놨는데, 거기서 모든 데이터를 application/json으로 보내버리는 바람에 그랬던 것임을 깨달았다. 초반에 설계할때 multipart/form-data를 염두해뒀었는데, 까먹었다. multipart/form-data가 들어올때는 건들지않고 그대로 보내도록 수정했더니 백엔드에서 데이터를 잘 받아온다.

### 🗨️ 오늘의 회고

- 이번주 과제 제출을 위해 이미지 제외하고 할 수 있는 것만 했는데도 오류고치느라 시간을 꽤나 썼다. 이미지처리는 어떻게 할지 계속 고민해 봐야겠다.
